
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>run5 : fold (3 classes) mySmallNet &#8212; maxSlimer</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=87e54e7c" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '1_unetSmall/code86/run5';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="run5 : fold (33 classes) mySmallNet" href="run6.html" />
    <link rel="prev" title="run4 : add fold (3 classes)" href="run4.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../readme.html">
  
  
  
  
  
  
    <p class="title logo__title">maxSlimer</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../readme.html">
                    maxSLIMER
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">ProjectUnet</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../readme.html">objective</a></li>
<li class="toctree-l1"><a class="reference internal" href="../db/readme.html">dataset</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../networks/small1.html">reduceMethods</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../networks/modelSizeParams.html">paramCalcMethods</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networks/summary_largeNet.html">netStruct: UnetLarge</a></li>
<li class="toctree-l2"><a class="reference internal" href="../networks/summary_mysmall.html">netStruct: mySmallNet</a></li>
<li class="toctree-l2"><a class="reference internal" href="../folding/readme.html">fold</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../results/readme.html">trainSummary</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="run1.html">run1 : ref no fold (33 classes)</a></li>



<li class="toctree-l2"><a class="reference internal" href="run2.html">run2 : ref no fold (3 classes)</a></li>



<li class="toctree-l2"><a class="reference internal" href="run3.html">run3 : ref no fold (3 classes) on small unet</a></li>



<li class="toctree-l2"><a class="reference internal" href="run4.html">run4 : add fold (3 classes)</a></li>



<li class="toctree-l2 current active"><a class="current reference internal" href="#">run5 :  fold (3 classes)  mySmallNet</a></li>



<li class="toctree-l2"><a class="reference internal" href="run6.html">run5 :  fold (33 classes)  mySmallNet</a></li>



</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../4max/readme.html">deploy</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../4max/1_train.html">(1) Train</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/2_quant.html">(2) Quantization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/3_eval.html">(3) Evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/4_sample.html">(4) Sample</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/5_yml.html">(5) YML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/6_loader.html">(6) loader</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/7_infer.html">(7) make</a></li>
<li class="toctree-l2"><a class="reference internal" href="../4max/8_burn.html">(8) burn</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="qNetEval.html">quantResultAnal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../results/report.html">report</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ProjectMobile</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../2_unetMobile/readme.html">project MobileNet Combination</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../2_unetMobile/combine.html">combining  motivation</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/SOLEROM/maxSlimer" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/SOLEROM/maxSlimer/issues/new?title=Issue%20on%20page%20%2F1_unetSmall/code86/run5.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/1_unetSmall/code86/run5.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>run5 :  fold (3 classes)  mySmallNet</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">run5 :  fold (3 classes)  mySmallNet</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conf">conf</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#layers">Layers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#model">model</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loss">loss</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#score">score</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizer">optimizer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scheduler">scheduler</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">summary</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#train">train</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-on-test">loss on test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-case-examine">test case examine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-test">new test</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#report">report</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="run5-fold-3-classes-mysmallnet">
<h1>run5 :  fold (3 classes)  mySmallNet<a class="headerlink" href="#run5-fold-3-classes-mysmallnet" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>img input 3x352x352</p></li>
<li><p>fold = 4</p></li>
<li><p>3 classes</p></li>
<li><p>model = myUNetSmall !!!!</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span><span class="nn">os</span>
<span class="c1">#apped depend on which machine </span>
<span class="n">paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/data/solai/aiArmory/pytorch/&#39;</span><span class="p">,</span> <span class="s1">&#39;/home/vlad/max78/aiArmory/pytorch/&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">armoInclude</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">armoTrain</span> <span class="kn">import</span> <span class="n">basicModel</span>
</pre></div>
</div>
</div>
</div>
<section id="conf">
<h2>conf<a class="headerlink" href="#conf" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># myPC</span>
<span class="n">DATASET_PATH</span> <span class="o">=</span> <span class="s1">&#39;/data/tinyai/maxCNN/ai8x-training/data/CamVid&#39;</span>
<span class="n">MODEL_PATH</span> <span class="o">=</span> <span class="s1">&#39;./unet_model_mySmall_x88_c3_e50_F4.pt&#39;</span>  
<span class="n">EPOCHS_TO_RUN</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">REDO</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># ## runServer</span>
<span class="c1"># DATASET_PATH = &#39;/home/vlad/Data/CamVid&#39;</span>
<span class="c1"># MODEL_PATH = &#39;/tmp/unet_model_mySmall_x88_c3_e50_F4.pt&#39;  </span>
<span class="c1"># REDO = True</span>
<span class="c1"># EPOCHS_TO_RUN = 50</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">INPUT_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">352</span><span class="p">,</span> <span class="mi">352</span><span class="p">)</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">8</span>

<span class="c1">## Model - basic reference model with no fold</span>
<span class="n">NUM_CLASS</span>   <span class="o">=</span>   <span class="mi">4</span>   <span class="c1">## class+1 for none</span>

<span class="n">FOLD_RATIO</span>  <span class="o">=</span>   <span class="mi">4</span>
<span class="n">NUM_CHANN</span>   <span class="o">=</span>   <span class="mi">48</span>  <span class="c1">## 3x352x352 -&gt; 48x88x88 (fold=4) !!!!!!!!!!!!!!!!!!!!!!!!!!!!</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">runDevice</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda:0&#39;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;cpu&#39;</span><span class="p">)</span> <span class="c1">#&lt;! The 1st CUDA device</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;runDevice: </span><span class="si">{</span><span class="n">runDevice</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>runDevice: cpu
</pre></div>
</div>
</div>
</div>
</section>
<section id="layers">
<h2>Layers<a class="headerlink" href="#layers" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">myUNetSmall</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">num_channels</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fold_ratio</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">myUNetSmall</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span> <span class="o">=</span> <span class="n">fold_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_classes</span> <span class="o">=</span> <span class="n">num_classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_final_channels</span> <span class="o">=</span> <span class="n">num_classes</span> <span class="o">*</span> <span class="n">fold_ratio</span> <span class="o">*</span> <span class="n">fold_ratio</span>

        <span class="k">def</span> <span class="nf">depthwise_separable_conv</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="n">out_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">out_channels</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prep0</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="n">num_channels</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep1</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prep2</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">enc1</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bneck</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">MaxPool2d</span><span class="p">(</span><span class="n">kernel_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upconv3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upconv2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">upconv1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ConvTranspose2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_padding</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dec0</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv_p1</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_p2</span> <span class="o">=</span> <span class="n">depthwise_separable_conv</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_p3</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_final_channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_final_channels</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep0</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="n">enc1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">enc2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc2</span><span class="p">(</span><span class="n">enc1</span><span class="p">)</span>
        <span class="n">enc3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc3</span><span class="p">(</span><span class="n">enc2</span><span class="p">)</span>

        <span class="n">bottleneck</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bneck</span><span class="p">(</span><span class="n">enc3</span><span class="p">)</span>

        <span class="n">dec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upconv3</span><span class="p">(</span><span class="n">bottleneck</span><span class="p">)</span>
        <span class="n">dec3</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dec3</span><span class="p">,</span> <span class="n">enc3</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dec3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec3</span><span class="p">(</span><span class="n">dec3</span><span class="p">)</span>
        
        <span class="n">dec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upconv2</span><span class="p">(</span><span class="n">dec3</span><span class="p">)</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dec2</span><span class="p">,</span> <span class="n">enc2</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dec2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec2</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span>
        
        <span class="n">dec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">upconv1</span><span class="p">(</span><span class="n">dec2</span><span class="p">)</span>
        <span class="n">dec1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">dec1</span><span class="p">,</span> <span class="n">enc1</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dec1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec1</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span>
        
        <span class="n">dec0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec0</span><span class="p">(</span><span class="n">dec1</span><span class="p">)</span>
        <span class="n">dec0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p1</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span>
        <span class="n">dec0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p2</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span>
        <span class="n">dec0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_p3</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span>
        <span class="n">dec0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">dec0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dec0</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data">
<h2>data<a class="headerlink" href="#data" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">filter_label</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">17</span><span class="p">]</span> <span class="c1"># car sky road</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="k">class</span> <span class="nc">Fold</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fold data to increase the number of channels. An interlaced approach is used in this folding</span>
<span class="sd">    as explained in [1].</span>

<span class="sd">    [1] https://arxiv.org/pdf/2203.16528.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fold_ratio</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span> <span class="o">=</span> <span class="n">fold_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span> <span class="o">=</span> <span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="c1"># Convert PIL image to tensor</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
            <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">img</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">img</span>

        <span class="n">img_folded</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span><span class="p">):</span>
                <span class="n">img_subsample</span> <span class="o">=</span> <span class="n">img_tensor</span><span class="p">[:,</span> <span class="n">i</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span><span class="p">,</span> <span class="n">j</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">fold_ratio</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">img_folded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">img_folded</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">img_folded</span><span class="p">,</span> <span class="n">img_subsample</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">img_folded</span> <span class="o">=</span> <span class="n">img_subsample</span>


        <span class="k">return</span> <span class="n">img_folded</span>
    


<span class="k">def</span> <span class="nf">unfold</span><span class="p">(</span><span class="n">img_batch</span><span class="p">,</span> <span class="n">fold_ratio</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unfold data to reduce the number of channels. An interlaced approach used in this folding</span>
<span class="sd">    as explained in [1]. This operation is the reverse of the transformation implemented</span>
<span class="sd">    at ai8x.fold class.</span>

<span class="sd">    [1] https://arxiv.org/pdf/2203.16528.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">fold_ratio</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">img_batch</span>

    <span class="n">num_out_channels</span> <span class="o">=</span> <span class="n">img_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="n">fold_ratio</span><span class="o">*</span><span class="n">fold_ratio</span><span class="p">)</span>

    <span class="n">img_batch_uf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">img_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_out_channels</span><span class="p">,</span>
                                <span class="n">img_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">fold_ratio</span><span class="p">,</span> <span class="n">img_batch</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">fold_ratio</span><span class="p">),</span>
                               <span class="n">dtype</span><span class="o">=</span><span class="n">img_batch</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">img_batch</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">requires_grad</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fold_ratio</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">fold_ratio</span><span class="p">):</span>
            <span class="n">ch_index_start</span> <span class="o">=</span> <span class="n">num_out_channels</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">fold_ratio</span> <span class="o">+</span> <span class="n">j</span><span class="p">)</span>
            <span class="n">ch_index_end</span> <span class="o">=</span> <span class="n">num_out_channels</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">fold_ratio</span> <span class="o">+</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">img_batch_uf</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">::</span><span class="n">fold_ratio</span><span class="p">,</span> <span class="n">j</span><span class="p">::</span><span class="n">fold_ratio</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">img_batch</span><span class="p">[:,</span> <span class="n">ch_index_start</span><span class="p">:</span><span class="n">ch_index_end</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="k">return</span> <span class="n">img_batch_uf</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CamVidDataset</span><span class="p">(</span><span class="n">Dataset</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_dir</span><span class="p">,</span> <span class="n">label_dir</span><span class="p">,</span> <span class="n">image_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label_transform</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_dir</span> <span class="o">=</span> <span class="n">image_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_dir</span> <span class="o">=</span> <span class="n">label_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span> <span class="o">=</span> <span class="n">image_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_transform</span> <span class="o">=</span> <span class="n">label_transform</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">image_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">image_dir</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label_paths</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">label_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">label_dir</span><span class="p">)])</span>
        
        <span class="c1"># Load class dictionary</span>
        <span class="n">class_dict_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;class_dict.csv&#39;</span><span class="p">)</span>
        <span class="n">class_dict</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">class_dict_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="o">**</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_label</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;...will filter classes&quot;</span><span class="p">)</span>
            <span class="n">class_dict_filter</span> <span class="o">=</span> <span class="n">class_dict</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">filter_label</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">class_dict_filter</span> <span class="o">=</span> <span class="n">class_dict</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">class_dict_filter</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;r&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;g&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">[</span><span class="n">r</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_paths</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="p">:</span>
            <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_transform</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label_transform</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        
        <span class="c1">## RGB to categorical   = 1x352x352</span>
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_segmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>  <span class="c1"># Convert label to numpy array before encoding</span>
        
        <span class="k">if</span> <span class="n">filter_label</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">old_value</span><span class="p">:</span> <span class="n">new_index</span> <span class="k">for</span> <span class="n">new_index</span><span class="p">,</span> <span class="n">old_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filter_label</span><span class="p">)}</span>
            <span class="c1">## nromilize label by mapping</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">)(</span><span class="n">label</span><span class="p">)</span>
        
        <span class="n">foldOperator</span> <span class="o">=</span> <span class="n">Fold</span><span class="p">(</span><span class="n">FOLD_RATIO</span><span class="p">)</span>
        <span class="n">label_fold</span> <span class="o">=</span> <span class="n">foldOperator</span><span class="p">(</span><span class="n">label</span><span class="p">)</span> <span class="c1">## 16x88x88</span>
        <span class="c1"># unfold_label = torch.argmax(label_fold, dim=0)      ## 1x88x88 </span>
        <span class="n">unfold_label</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">label_fold</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># ## fold after encoding</span>
        <span class="c1"># foldOperator = Fold(FOLD_RATIO)</span>
        <span class="c1"># # duplicate label to 3 channels</span>
        <span class="c1"># label_tensor = torch.tensor(label, dtype=torch.int64)</span>
        <span class="c1"># label_tensor_3ch = label_tensor.unsqueeze(0).repeat(3, 1, 1)</span>
        <span class="c1"># # fold label</span>
        <span class="c1"># label = foldOperator(label_tensor_3ch)</span>

        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="n">unfold_label</span>

    <span class="k">def</span> <span class="nf">encode_segmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">colormap</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

<span class="c1"># Step 4: Data Transformation and DataLoader</span>
<span class="n">image_transform</span> <span class="o">=</span> <span class="n">TorchVisionTrns</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">TorchVisionTrns</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">INPUT_SIZE</span><span class="p">),</span>
    <span class="n">Fold</span><span class="p">(</span><span class="n">FOLD_RATIO</span><span class="p">),</span>
    <span class="n">TorchVisionTrns</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">()</span>
<span class="p">])</span>

<span class="n">label_transform</span> <span class="o">=</span> <span class="n">TorchVisionTrns</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
    <span class="n">TorchVisionTrns</span><span class="o">.</span><span class="n">Resize</span><span class="p">(</span><span class="n">INPUT_SIZE</span><span class="p">),</span>
    <span class="c1"># Fold(FOLD_RATIO),</span>
<span class="p">])</span>

<span class="n">train_dataset</span> <span class="o">=</span> <span class="n">CamVidDataset</span><span class="p">(</span>
    <span class="n">image_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">),</span>
    <span class="n">label_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;train_labels&#39;</span><span class="p">),</span>
    <span class="n">image_transform</span><span class="o">=</span><span class="n">image_transform</span><span class="p">,</span>
    <span class="n">label_transform</span><span class="o">=</span><span class="n">label_transform</span>
<span class="p">)</span>

<span class="n">val_dataset</span> <span class="o">=</span> <span class="n">CamVidDataset</span><span class="p">(</span>
    <span class="c1">## change to have more data in val then in test</span>
    <span class="n">image_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">),</span>
    <span class="n">label_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;test_labels&#39;</span><span class="p">),</span>
    <span class="n">image_transform</span><span class="o">=</span><span class="n">image_transform</span><span class="p">,</span>
    <span class="n">label_transform</span><span class="o">=</span><span class="n">label_transform</span>
<span class="p">)</span>

<span class="n">test_dataset</span> <span class="o">=</span> <span class="n">CamVidDataset</span><span class="p">(</span>
    <span class="c1">## change to have more data in val then in test</span>
    <span class="n">image_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;val&#39;</span><span class="p">),</span>
    <span class="n">label_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATASET_PATH</span><span class="p">,</span> <span class="s1">&#39;val_labels&#39;</span><span class="p">),</span>
    <span class="n">image_transform</span><span class="o">=</span><span class="n">image_transform</span><span class="p">,</span>
    <span class="n">label_transform</span><span class="o">=</span><span class="n">label_transform</span>
<span class="p">)</span>

<span class="n">dlTrain</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">dlVal</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">val_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">dlTest</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span><span class="n">test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>...will filter classes
...will filter classes
...will filter classes
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/data/solai/venvMamabaFixel/lib/python3.11/site-packages/torchvision/transforms/v2/_deprecated.py:42: UserWarning: The transform `ToTensor()` is deprecated and will be removed in a future release. Instead, please use `v2.Compose([v2.ToImage(), v2.ToDtype(torch.float32, scale=True)])`.Output is equivalent up to float precision.
  warnings.warn(
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;train_loader len =  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dlTrain</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;val_loader len =  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dlVal</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;test_loader len =  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dlTest</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>train_loader len =  100
val_loader len =  100
test_loader len =  100
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="model">
<h1>model<a class="headerlink" href="#model" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oModel</span> <span class="o">=</span> <span class="n">myUNetSmall</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="n">NUM_CLASS</span><span class="p">,</span> <span class="n">num_channels</span><span class="o">=</span><span class="n">NUM_CHANN</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fold_ratio</span><span class="o">=</span><span class="n">FOLD_RATIO</span><span class="p">)</span>
<span class="n">oModel</span> <span class="o">=</span> <span class="n">oModel</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">runDevice</span><span class="p">)</span>
<span class="n">myTrain</span> <span class="o">=</span> <span class="n">basicModel</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">oModel</span><span class="p">,</span><span class="n">CheckpointFile</span><span class="o">=</span><span class="n">MODEL_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="loss">
<h2>loss<a class="headerlink" href="#loss" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hL</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">()</span>
<span class="n">hL</span> <span class="o">=</span> <span class="n">hL</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">runDevice</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="score">
<h2>score<a class="headerlink" href="#score" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Given the shape of outputs is [8, 32, 80, 80], </span>
<span class="c1"># applying torch.max(outputs, 1) will reduce the dimension</span>
<span class="c1"># from 32 to 1 by finding the maximum value along the</span>
<span class="c1"># second dimension (dim=1). </span>
<span class="c1"># vals:  will be The maximum values along the specified dimension (dim=1) </span>
<span class="c1"># preds: The indices of the maximum values along the specified dimension</span>
<span class="c1">#         with shape of preds will be [8, 80, 80].</span>

<span class="k">def</span> <span class="nf">hS</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
    <span class="n">vals</span> <span class="p">,</span> <span class="n">preds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">corrects</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">preds</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="n">labels</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corrects</span><span class="o">.</span><span class="n">double</span><span class="p">()</span> <span class="o">/</span> <span class="n">labels</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="optimizer">
<h2>optimizer<a class="headerlink" href="#optimizer" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oOpt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="n">oModel</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="n">betas</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">),</span> <span class="n">weight_decay</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="scheduler">
<h2>scheduler<a class="headerlink" href="#scheduler" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">oSch</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">OneCycleLR</span><span class="p">(</span><span class="n">oOpt</span><span class="p">,</span> <span class="n">max_lr</span> <span class="o">=</span> <span class="mf">5e-4</span><span class="p">,</span> <span class="n">total_steps</span> <span class="o">=</span> <span class="n">EPOCHS_TO_RUN</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="summary">
<h2>summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myTrain</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span> <span class="n">dlTrain</span><span class="p">,</span> <span class="n">dlVal</span><span class="p">,</span> <span class="n">oOpt</span><span class="p">,</span> <span class="n">EPOCHS_TO_RUN</span> <span class="p">,</span> <span class="n">BATCH_SIZE</span> <span class="p">,</span> <span class="n">hL</span><span class="p">,</span> <span class="n">hS</span><span class="p">,</span> <span class="n">oSch</span> <span class="o">=</span> <span class="n">oSch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=======================  info   =========================================================
numEpoch = 50 ; batchSize = 8
Train: 
    len train dataset 100 / batchSize  8 = len Train 13 
    dlTrain: iter tX shape   = torch.Size([8, 48, 88, 88]) 
    dlTrain: iter vY ; shape = torch.Size([8, 88, 88])
Val: 
    dlVal  : tensor[0].shape = torch.Size([8, 48, 88, 88])
    dlVal  : tensor[1].shape = torch.Size([8, 88, 88])
=======================  summary   =========================================================
==========================================================================================
Layer (type:depth-idx)                   Output Shape              Param #
==========================================================================================
myUNetSmall                              [8, 64, 88, 88]           --
├─Sequential: 1-1                        [8, 32, 88, 88]           --
│    └─Conv2d: 2-1                       [8, 48, 88, 88]           96
│    └─BatchNorm2d: 2-2                  [8, 48, 88, 88]           96
│    └─ReLU: 2-3                         [8, 48, 88, 88]           --
│    └─Conv2d: 2-4                       [8, 32, 88, 88]           1,568
│    └─BatchNorm2d: 2-5                  [8, 32, 88, 88]           64
│    └─ReLU: 2-6                         [8, 32, 88, 88]           --
├─Sequential: 1-2                        [8, 32, 88, 88]           --
│    └─Conv2d: 2-7                       [8, 32, 88, 88]           64
│    └─BatchNorm2d: 2-8                  [8, 32, 88, 88]           64
│    └─ReLU: 2-9                         [8, 32, 88, 88]           --
│    └─Conv2d: 2-10                      [8, 32, 88, 88]           1,056
│    └─BatchNorm2d: 2-11                 [8, 32, 88, 88]           64
│    └─ReLU: 2-12                        [8, 32, 88, 88]           --
├─Sequential: 1-3                        [8, 16, 88, 88]           --
│    └─Conv2d: 2-13                      [8, 32, 88, 88]           64
│    └─BatchNorm2d: 2-14                 [8, 32, 88, 88]           64
│    └─ReLU: 2-15                        [8, 32, 88, 88]           --
│    └─Conv2d: 2-16                      [8, 16, 88, 88]           528
│    └─BatchNorm2d: 2-17                 [8, 16, 88, 88]           32
│    └─ReLU: 2-18                        [8, 16, 88, 88]           --
├─Sequential: 1-4                        [8, 8, 88, 88]            --
│    └─Conv2d: 2-19                      [8, 16, 88, 88]           160
│    └─BatchNorm2d: 2-20                 [8, 16, 88, 88]           32
│    └─ReLU: 2-21                        [8, 16, 88, 88]           --
│    └─Conv2d: 2-22                      [8, 8, 88, 88]            136
│    └─BatchNorm2d: 2-23                 [8, 8, 88, 88]            16
│    └─ReLU: 2-24                        [8, 8, 88, 88]            --
├─Sequential: 1-5                        [8, 16, 44, 44]           --
│    └─MaxPool2d: 2-25                   [8, 8, 44, 44]            --
│    └─Sequential: 2-26                  [8, 16, 44, 44]           --
│    │    └─Conv2d: 3-1                  [8, 8, 44, 44]            80
│    │    └─BatchNorm2d: 3-2             [8, 8, 44, 44]            16
│    │    └─ReLU: 3-3                    [8, 8, 44, 44]            --
│    │    └─Conv2d: 3-4                  [8, 16, 44, 44]           144
│    │    └─BatchNorm2d: 3-5             [8, 16, 44, 44]           32
│    │    └─ReLU: 3-6                    [8, 16, 44, 44]           --
├─Sequential: 1-6                        [8, 32, 22, 22]           --
│    └─MaxPool2d: 2-27                   [8, 16, 22, 22]           --
│    └─Sequential: 2-28                  [8, 32, 22, 22]           --
│    │    └─Conv2d: 3-7                  [8, 16, 22, 22]           160
│    │    └─BatchNorm2d: 3-8             [8, 16, 22, 22]           32
│    │    └─ReLU: 3-9                    [8, 16, 22, 22]           --
│    │    └─Conv2d: 3-10                 [8, 32, 22, 22]           544
│    │    └─BatchNorm2d: 3-11            [8, 32, 22, 22]           64
│    │    └─ReLU: 3-12                   [8, 32, 22, 22]           --
├─Sequential: 1-7                        [8, 64, 11, 11]           --
│    └─MaxPool2d: 2-29                   [8, 32, 11, 11]           --
│    └─Sequential: 2-30                  [8, 64, 11, 11]           --
│    │    └─Conv2d: 3-13                 [8, 32, 11, 11]           320
│    │    └─BatchNorm2d: 3-14            [8, 32, 11, 11]           64
│    │    └─ReLU: 3-15                   [8, 32, 11, 11]           --
│    │    └─Conv2d: 3-16                 [8, 64, 11, 11]           2,112
│    │    └─BatchNorm2d: 3-17            [8, 64, 11, 11]           128
│    │    └─ReLU: 3-18                   [8, 64, 11, 11]           --
├─ConvTranspose2d: 1-8                   [8, 32, 22, 22]           18,464
├─Sequential: 1-9                        [8, 32, 22, 22]           --
│    └─Conv2d: 2-31                      [8, 64, 22, 22]           640
│    └─BatchNorm2d: 2-32                 [8, 64, 22, 22]           128
│    └─ReLU: 2-33                        [8, 64, 22, 22]           --
│    └─Conv2d: 2-34                      [8, 32, 22, 22]           2,080
│    └─BatchNorm2d: 2-35                 [8, 32, 22, 22]           64
│    └─ReLU: 2-36                        [8, 32, 22, 22]           --
├─ConvTranspose2d: 1-10                  [8, 16, 44, 44]           4,624
├─Sequential: 1-11                       [8, 16, 44, 44]           --
│    └─Conv2d: 2-37                      [8, 32, 44, 44]           320
│    └─BatchNorm2d: 2-38                 [8, 32, 44, 44]           64
│    └─ReLU: 2-39                        [8, 32, 44, 44]           --
│    └─Conv2d: 2-40                      [8, 16, 44, 44]           528
│    └─BatchNorm2d: 2-41                 [8, 16, 44, 44]           32
│    └─ReLU: 2-42                        [8, 16, 44, 44]           --
├─ConvTranspose2d: 1-12                  [8, 8, 88, 88]            1,160
├─Sequential: 1-13                       [8, 16, 88, 88]           --
│    └─Conv2d: 2-43                      [8, 16, 88, 88]           160
│    └─BatchNorm2d: 2-44                 [8, 16, 88, 88]           32
│    └─ReLU: 2-45                        [8, 16, 88, 88]           --
│    └─Conv2d: 2-46                      [8, 16, 88, 88]           272
│    └─BatchNorm2d: 2-47                 [8, 16, 88, 88]           32
│    └─ReLU: 2-48                        [8, 16, 88, 88]           --
├─Sequential: 1-14                       [8, 32, 88, 88]           --
│    └─Conv2d: 2-49                      [8, 16, 88, 88]           160
│    └─BatchNorm2d: 2-50                 [8, 16, 88, 88]           32
│    └─ReLU: 2-51                        [8, 16, 88, 88]           --
│    └─Conv2d: 2-52                      [8, 32, 88, 88]           544
│    └─BatchNorm2d: 2-53                 [8, 32, 88, 88]           64
│    └─ReLU: 2-54                        [8, 32, 88, 88]           --
├─Sequential: 1-15                       [8, 32, 88, 88]           --
│    └─Conv2d: 2-55                      [8, 32, 88, 88]           64
│    └─BatchNorm2d: 2-56                 [8, 32, 88, 88]           64
│    └─ReLU: 2-57                        [8, 32, 88, 88]           --
│    └─Conv2d: 2-58                      [8, 32, 88, 88]           1,056
│    └─BatchNorm2d: 2-59                 [8, 32, 88, 88]           64
│    └─ReLU: 2-60                        [8, 32, 88, 88]           --
├─Sequential: 1-16                       [8, 32, 88, 88]           --
│    └─Conv2d: 2-61                      [8, 32, 88, 88]           64
│    └─BatchNorm2d: 2-62                 [8, 32, 88, 88]           64
│    └─ReLU: 2-63                        [8, 32, 88, 88]           --
│    └─Conv2d: 2-64                      [8, 32, 88, 88]           1,056
│    └─BatchNorm2d: 2-65                 [8, 32, 88, 88]           64
│    └─ReLU: 2-66                        [8, 32, 88, 88]           --
├─Sequential: 1-17                       [8, 32, 88, 88]           --
│    └─Conv2d: 2-67                      [8, 32, 88, 88]           1,056
│    └─BatchNorm2d: 2-68                 [8, 32, 88, 88]           64
├─Sequential: 1-18                       [8, 64, 88, 88]           --
│    └─Conv2d: 2-69                      [8, 64, 88, 88]           2,112
│    └─BatchNorm2d: 2-70                 [8, 64, 88, 88]           128
==========================================================================================
Total params: 43,056
Trainable params: 43,056
Non-trainable params: 0
Total mult-adds (Units.MEGABYTES): 880.10
==========================================================================================
Input size (MB): 11.89
Forward/backward pass size (MB): 550.63
Params size (MB): 0.17
Estimated Total Size (MB): 562.70
==========================================================================================
=======================  verify   =========================================================
ERROR: last layer size [8, 64, 88, 88] != vY shape [8, 88, 88] ; FAIL 
==========================================================================================
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="train">
<h1>train<a class="headerlink" href="#train" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## train or load:</span>
<span class="k">if</span> <span class="n">REDO</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">trained</span> <span class="o">=</span> <span class="n">myTrain</span><span class="o">.</span><span class="n">TrainModel</span><span class="p">(</span><span class="n">dlTrain</span><span class="p">,</span> <span class="n">dlVal</span><span class="p">,</span> <span class="n">oOpt</span><span class="p">,</span> <span class="n">EPOCHS_TO_RUN</span><span class="p">,</span> <span class="n">hL</span><span class="p">,</span> <span class="n">hS</span><span class="p">,</span> <span class="n">oSch</span> <span class="o">=</span> <span class="n">oSch</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">trained</span> <span class="o">=</span> <span class="n">myTrain</span><span class="o">.</span><span class="n">loadModel</span><span class="p">(</span><span class="n">MODEL_PATH</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>model loaded from ./unet_model_mySmall_x88_c3_e50_F4.pt
</pre></div>
</div>
</div>
</div>
<section id="results">
<h2>results<a class="headerlink" href="#results" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myTrain</span><span class="o">.</span><span class="n">plotTrainResults</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/6a72fdebd233f8a021dffbc86a8fc49f21188bc0c06e2ab9dc1345ef03ed10bc.png" src="../../_images/6a72fdebd233f8a021dffbc86a8fc49f21188bc0c06e2ab9dc1345ef03ed10bc.png" />
</div>
</div>
</section>
<section id="loss-on-test">
<h2>loss on test<a class="headerlink" href="#loss-on-test" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">test_score</span> <span class="o">=</span> <span class="n">myTrain</span><span class="o">.</span><span class="n">evaluate_test_data</span><span class="p">(</span><span class="n">testData</span> <span class="o">=</span> <span class="n">dlTest</span> <span class="p">,</span><span class="n">score_fn</span><span class="o">=</span><span class="n">hS</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Test Score: 0.9289164315797839
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-case-examine">
<h2>test case examine<a class="headerlink" href="#test-case-examine" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">visualize_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">image</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  
    <span class="n">unfold_img</span><span class="o">=</span><span class="n">unfold</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">FOLD_RATIO</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Remove batch dimension and move to CPU</span>

    <span class="c1"># Debugging: Check unique values in the output and prediction</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unique values in the raw output:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Unique values in the predicted segmentation:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">pred</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>

    <span class="c1"># Convert the tensors to images for visualization</span>
    <span class="n">unfold_img</span> <span class="o">=</span> <span class="n">unfold_img</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Convert from (C, H, W) to (H, W, C)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pred</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="c1"># Plot the images</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">unfold_img</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input Image&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Ground Truth&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted Segmentation&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Visualize prediction on a sample image from the validation set</span>
<span class="n">visualize_prediction</span><span class="p">(</span><span class="n">myTrain</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">val_dataset</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unique values in the raw output: [-1.6643046 -1.6031445 -1.602401  ... 12.445987  12.658648  12.721593 ]
Unique values in the predicted segmentation: [0 1 2 3]
</pre></div>
</div>
<img alt="../../_images/b3db57d1257b165fa7f4b32ef7668f20464866f60d89158c15ec3496eac463af.png" src="../../_images/b3db57d1257b165fa7f4b32ef7668f20464866f60d89158c15ec3496eac463af.png" />
</div>
</div>
</section>
<section id="new-test">
<h2>new test<a class="headerlink" href="#new-test" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageOps</span>

<span class="k">def</span> <span class="nf">visualize_new_prediction</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">new_image_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_image_path</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">new_image_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">)</span>
    
    <span class="c1">## make the same size as the training image</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;orig image.size = </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">test_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">960</span><span class="p">,</span> <span class="mi">720</span><span class="p">)</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ImageOps</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">test_size</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">Image</span><span class="o">.</span><span class="n">LANCZOS</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;image.size = </span><span class="si">{</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    


    
    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">image_transform</span><span class="p">(</span><span class="n">image</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">)</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Remove batch dimension and move to CPU</span>
    
    <span class="c1"># Convert the tensor image to numpy for visualization</span>
    <span class="n">image_tensor</span> <span class="o">=</span> <span class="n">unfold</span><span class="p">(</span><span class="n">image_tensor</span><span class="p">,</span> <span class="n">FOLD_RATIO</span><span class="p">)</span>
    <span class="n">image_model</span> <span class="o">=</span> <span class="n">image_tensor</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>  <span class="c1"># Convert from (C, H, W) to (H, W, C)</span>

    <span class="c1"># Plot the images</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Input Image&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">image_model</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Model Image&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Predicted Segmentation&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">visualize_new_prediction</span><span class="p">(</span><span class="n">myTrain</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;/home/vlad/Data/myTestImg/carPark1.jpeg&#39;</span><span class="p">)</span>    
<span class="n">visualize_new_prediction</span><span class="p">(</span><span class="n">myTrain</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;/data/tinyai/maxCNN/ai8x-training/data/CamVid/test/0016E5_08025.png&#39;</span><span class="p">)</span>    
<span class="n">visualize_new_prediction</span><span class="p">(</span><span class="n">myTrain</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;/data/solai/projB/1_unteSmall/results/carPark1.jpeg&#39;</span><span class="p">)</span>    
<span class="n">visualize_new_prediction</span><span class="p">(</span><span class="n">myTrain</span><span class="o">.</span><span class="n">model</span><span class="p">,</span><span class="s1">&#39;/data/solai/projB/1_unteSmall/results/newTest1.jpg&#39;</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>orig image.size = (960, 720)
image.size = (960, 720)
</pre></div>
</div>
<img alt="../../_images/bb772f6dc71faef0b1ce25514d880fa0285ff421420bb6e9ad181dc567432886.png" src="../../_images/bb772f6dc71faef0b1ce25514d880fa0285ff421420bb6e9ad181dc567432886.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>orig image.size = (721, 1600)
image.size = (960, 720)
</pre></div>
</div>
<img alt="../../_images/1143007bd83654b79bb6b35708ac5d8a97784305f6e9c6cd25a2c3be3111cbe7.png" src="../../_images/1143007bd83654b79bb6b35708ac5d8a97784305f6e9c6cd25a2c3be3111cbe7.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>orig image.size = (400, 300)
image.size = (960, 720)
</pre></div>
</div>
<img alt="../../_images/3c8a74e35d767f11e759078ed902162c512af8b4f9c2b2fed660c08cf15e63f5.png" src="../../_images/3c8a74e35d767f11e759078ed902162c512af8b4f9c2b2fed660c08cf15e63f5.png" />
</div>
</div>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="report">
<h1>report<a class="headerlink" href="#report" title="Link to this heading">#</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;trainning   : EPOCHS_TO_RUN=</span><span class="si">{</span><span class="n">EPOCHS_TO_RUN</span><span class="si">}</span><span class="s2"> ; batch=</span><span class="si">{</span><span class="n">BATCH_SIZE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model       : file=</span><span class="si">{</span><span class="n">MODEL_PATH</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input data  : train_len =  </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dlTrain</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> ; test_len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dlVal</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> ; val_len=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dlTest</span><span class="o">.</span><span class="n">dataset</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;img input   : INPUT_SIZE=</span><span class="si">{</span><span class="n">INPUT_SIZE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;model       : NUM_CLASS=</span><span class="si">{</span><span class="n">NUM_CLASS</span><span class="si">}</span><span class="s2"> ; NUM_CHANN=</span><span class="si">{</span><span class="n">NUM_CHANN</span><span class="si">}</span><span class="s2"> ; FOLD_RATIO=</span><span class="si">{</span><span class="n">FOLD_RATIO</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;score       : val_score=</span><span class="si">{</span><span class="n">myTrain</span><span class="o">.</span><span class="n">lValScore</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> ; val_loss </span><span class="si">{</span><span class="n">myTrain</span><span class="o">.</span><span class="n">lValLoss</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;            : test_score=</span><span class="si">{</span><span class="n">test_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trainable parameters: </span><span class="si">{</span><span class="n">myTrain</span><span class="o">.</span><span class="n">parma_stat</span><span class="p">()[</span><span class="s1">&#39;trainable_params&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parameters_size_in_megabytes : </span><span class="si">{</span><span class="n">myTrain</span><span class="o">.</span><span class="n">parma_stat</span><span class="p">()[</span><span class="s1">&#39;total_size_in_megabytes&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>trainning   : EPOCHS_TO_RUN=50 ; batch=8
model       : file=./unet_model_mySmall_x88_c3_e50_F4.pt
input data  : train_len =  100 ; test_len=100 ; val_len=100 
img input   : INPUT_SIZE=(352, 352)
model       : NUM_CLASS=4 ; NUM_CHANN=48 ; FOLD_RATIO=4
score       : val_score=0.9131630272157311 ; val_loss 1.4180119119841477
            : test_score=0.9289164315797839
Trainable parameters: 43056
parameters_size_in_megabytes : 0.16424560546875
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./1_unetSmall/code86"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="run4.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">run4 : add fold (3 classes)</p>
      </div>
    </a>
    <a class="right-next"
       href="run6.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">run5 :  fold (33 classes)  mySmallNet</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">run5 :  fold (3 classes)  mySmallNet</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#conf">conf</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#layers">Layers</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data">data</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#model">model</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loss">loss</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#score">score</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimizer">optimizer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scheduler">scheduler</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">summary</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#train">train</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#results">results</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#loss-on-test">loss on test</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#test-case-examine">test case examine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#new-test">new test</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#report">report</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By 0xsol
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>